# ---
# Uses: git, zsh

- name: Install Oh My Zsh
  become: false
  block:
    - name: Check if ~/.oh-my-zsh directory exists
      stat:
        path: "{{ ansible_env.HOME }}/.oh-my-zsh"
      register: oh_my_zsh_dir

    - name: Download Oh My Zsh installation script
      get_url:
        url: https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh
        dest: /tmp/install_ohmyzsh.sh
      when: not oh_my_zsh_dir.stat.exists

    - name: Run Oh My Zsh installation script
      command: sh /tmp/install_ohmyzsh.sh --unattended
      register: ohmyzsh_result
      failed_when: "'FAILED' in ohmyzsh_result.stderr"
      when: not oh_my_zsh_dir.stat.exists

    - name: Remove Oh My Zsh installation script
      ansible.builtin.file:
        path: /tmp/install_ohmyzsh.sh
        state: absent
      when: not oh_my_zsh_dir.stat.exists

    - name: Download powerline-fonts repository
      ansible.builtin.git:
        repo: 'https://github.com/powerline/fonts.git'
        dest: /tmp/powerline-fonts
        depth: 1

    - name: Run powerline-fonts installation script
      command: sh /tmp/fonts/install.sh --unattended
      register: fonts_result
      failed_when: "'FAILED' in fonts_result.stderr"

    - name: Remove powerline-fonts installation script
      ansible.builtin.file:
        path: /tmp/powerline-fonts
        state: absent
